# 點餐系統後台 Use Cases

## Use Cases

### A. 開店前配置（分店管理員）

1. 建立 **單品分類**
2. 建立 **單品**（綁定分類，可選擇規格/加購）
3. 建立 **菜單** 與 **菜單版本**  
   - 設定名稱、生效日期/時段  
   - 加入分類與單品  
   - 設定單品價格與每日/時段可售量  
   - 發佈菜單版本（ACTIVE）
4. 配置 **店內桌位**  
   - 拖拉式 UI  
   - 每桌生成唯一 QRCode (qr_token)

---

### B. 顧客掃碼點餐（同桌多人，各自下單）

1. 顧客掃描 `qr_token` → 系統解析 `branch_id/table_id`  
2. 若無當前 `visit`，則建立新訪次（Visit/Seating Session）  
3. 為每位顧客生成 `customer_token`（標識個人訂單）  
4. 顯示有效的 `menu_version` 與可售量余額  
5. 顧客建立 **個人訂單**（綁定 `visit_id + customer_token`）  
6. 下單提交：  
   - 檢查時段與配額（Redis Lua 原子操作）  
   - 建立訂單與訂單項目快照  
   - 發送出餐事件給 KDS

---

### C. 出餐（KDS/內場）

1. 訂單依照 `visit_id`（桌）與建立時間排序顯示  
2. 狀態流轉：PLACED → ACCEPTED → IN_PROGRESS → READY → SERVED / CANCELED

---

### D. 清桌 / 結束訪次

1. 管理員或 POS 將 `visit` 標記 CLOSED  
2. 桌位釋放，後續可再次開桌  
3. 可選擇將多張訂單合併為一個結帳單 (bill)

---

### E. 報表（分店管理員）

- 查看當日營銷數據  
  - GMV、訂單數、客單價  
  - 熱銷單品 Top N  
  - 售罄率  
  - 翻台率（基於 visit）  
  - 訂單取消/退餐率  
  - 出餐時長（PLACED → READY → SERVED）

---

## 討論要點

1. **菜單版本化 / 快照**
   - 訂單綁定當下生效的菜單快照，避免改價影響歷史。

2. **單品規格與加購 (Modifiers/Options)**
   - 支援多層次選項，例如加料、份量、辣度。

3. **可售量粒度**
   - 每日/時段限制，Redis 原子扣減，取消時回補。

4. **Visit 概念**
   - QR 綁定桌，Visit 表示一次到店；同桌顧客各自下單但歸屬同 Visit。

5. **結帳策略**
   - 支援合併或分開結帳（MVP 可先留白）。

6. **營業日 / 換日**
   - 餐飲常用「營業日」（如 06:00 換日）而非自然日。

7. **競態與冪等**
   - 下單時用 `client_txn_id` + Redis 保證冪等。  
   - Redis Lua 腳本檢查/扣減配額，確保不超賣。

8. **上/下架與售罄**
   - 後台需能即時暫停販售，前台同步更新。

9. **RBAC 權限**
   - 餐廳管理員、分店管理員、內場(KDS)、前台(POS) 權限區分。

10. **報表指標**
    - GMV、訂單數、客單價、TopN 單品、售罄率、翻台率、退餐率、出餐時長。

---

---




